generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model User {
    id                   String    @id @default(uuid())
    email                String    @unique
    password             String
    firstName            String
    lastName             String
    phoneNumber          String?
    dateOfBirth          DateTime?
    driverLicenseNumber  String?
    role                 Role      @default(USER)
    isActive             Boolean   @default(true)
    resetPasswordToken   String?
    resetPasswordExpires DateTime?
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt

    bookings           Booking[]
    waitlist           Waitlist[]
    emailNotifications EmailNotification[]
    blockedSlots       BlockedSlot[]

    @@index([email])
}

enum Role {
    USER
    ADMIN
}

model AppointmentType {
    id              String   @id @default(uuid())
    typeName        String   @unique
    description     String?
    durationMinutes Int      @default(30)
    isActive        Boolean  @default(true)
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    locationAppointmentTypes LocationAppointmentType[]
    slotConfigurations       SlotConfiguration[]
    bookings                 Booking[]
    waitlist                 Waitlist[]
    specialDates             SpecialDate[]
    blockedSlots             BlockedSlot[]

    @@index([isActive])
}

model Location {
    id           String   @id @default(uuid())
    locationName String   @unique
    addressLine1 String
    addressLine2 String?
    city         String
    state        String
    zipCode      String
    phoneNumber  String?
    email        String?
    isActive     Boolean  @default(true)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    locationAppointmentTypes LocationAppointmentType[]
    slotConfigurations       SlotConfiguration[]
    bookings                 Booking[]
    waitlist                 Waitlist[]
    specialDates             SpecialDate[]
    blockedSlots             BlockedSlot[]

    @@index([isActive])
    @@index([city, state])
}

model LocationAppointmentType {
    id                String   @id @default(uuid())
    locationId        String
    appointmentTypeId String
    isActive          Boolean  @default(true)
    createdAt         DateTime @default(now())

    location        Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)
    appointmentType AppointmentType @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)

    @@unique([locationId, appointmentTypeId])
    @@index([locationId])
    @@index([appointmentTypeId])
}

model SlotConfiguration {
    id                        String   @id @default(uuid())
    locationId                String
    appointmentTypeId         String
    availableDays             Int[] // Array of 0-6 (Sunday-Saturday)
    startTime                 String // Format: "HH:MM:SS"
    endTime                   String // Format: "HH:MM:SS"
    slotDurationMinutes       Int      @default(30)
    slotsPerInterval          Int      @default(1)
    bufferTimeMinutes         Int      @default(0)
    advanceBookingDays        Int      @default(90)
    sameDayBookingCutoffHours Int      @default(2)
    minAdvanceBookingHours    Int      @default(24)
    isActive                  Boolean  @default(true)
    createdAt                 DateTime @default(now())
    updatedAt                 DateTime @updatedAt

    location        Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)
    appointmentType AppointmentType @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)

    @@unique([locationId, appointmentTypeId])
    @@index([locationId])
    @@index([appointmentTypeId])
}

model SpecialDate {
    id                           String          @id @default(uuid())
    locationId                   String?
    appointmentTypeId            String?
    date                         DateTime        @db.Date
    dateType                     SpecialDateType
    reason                       String?
    isClosed                     Boolean         @default(false)
    modifiedStartTime            String?
    modifiedEndTime              String?
    appliesToAllLocations        Boolean         @default(false)
    appliesToAllAppointmentTypes Boolean         @default(false)
    createdAt                    DateTime        @default(now())
    updatedAt                    DateTime        @updatedAt

    location        Location?        @relation(fields: [locationId], references: [id], onDelete: Cascade)
    appointmentType AppointmentType? @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)

    @@index([date])
    @@index([locationId])
    @@index([appointmentTypeId])
}

enum SpecialDateType {
    HOLIDAY
    CLOSURE
    MODIFIED_HOURS
}

model BlockedSlot {
    id                           String   @id @default(uuid())
    locationId                   String
    appointmentTypeId            String?
    blockedDate                  DateTime @db.Date
    blockedStartTime             String
    blockedEndTime               String
    reason                       String?
    appliesToAllAppointmentTypes Boolean  @default(false)
    createdBy                    String?
    createdAt                    DateTime @default(now())

    location        Location         @relation(fields: [locationId], references: [id], onDelete: Cascade)
    appointmentType AppointmentType? @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)
    user            User?            @relation(fields: [createdBy], references: [id], onDelete: SetNull)

    @@index([locationId, blockedDate])
    @@index([appointmentTypeId])
}

model Booking {
    id                 String        @id @default(uuid())
    userId             String
    appointmentTypeId  String
    locationId         String
    bookingReference   String        @unique @default(cuid())
    appointmentDate    DateTime      @db.Date
    appointmentTime    String
    status             BookingStatus @default(CONFIRMED)
    bookingDate        DateTime      @default(now())
    cancellationDate   DateTime?
    cancelledBy        CancelledBy?
    cancellationReason String?
    notes              String?
    createdAt          DateTime      @default(now())
    updatedAt          DateTime      @updatedAt

    user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    appointmentType    AppointmentType     @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)
    location           Location            @relation(fields: [locationId], references: [id], onDelete: Cascade)
    emailNotifications EmailNotification[]

    @@index([userId])
    @@index([locationId, appointmentDate])
    @@index([appointmentTypeId, appointmentDate])
    @@index([status])
    @@index([bookingReference])
    @@index([locationId, appointmentTypeId, appointmentDate, appointmentTime, status])
}

enum BookingStatus {
    CONFIRMED
    CANCELLED
    COMPLETED
    NO_SHOW
}

enum CancelledBy {
    USER
    ADMIN
}

model Waitlist {
    id                 String         @id @default(uuid())
    userId             String
    appointmentTypeId  String
    locationId         String
    preferredDateStart DateTime?      @db.Date
    preferredDateEnd   DateTime?      @db.Date
    status             WaitlistStatus @default(WAITING)
    position           Int?
    joinedAt           DateTime       @default(now())
    notifiedAt         DateTime?
    notificationCount  Int            @default(0)
    expiresAt          DateTime?
    notes              String?
    createdAt          DateTime       @default(now())
    updatedAt          DateTime       @updatedAt

    user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    appointmentType    AppointmentType     @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)
    location           Location            @relation(fields: [locationId], references: [id], onDelete: Cascade)
    emailNotifications EmailNotification[]

    @@index([userId])
    @@index([status])
    @@index([appointmentTypeId, locationId])
    @@index([joinedAt])
}

enum WaitlistStatus {
    WAITING
    NOTIFIED
    BOOKED
    EXPIRED
    CANCELLED
}

model EmailNotification {
    id             String      @id @default(uuid())
    userId         String
    emailType      EmailType
    recipientEmail String
    subject        String
    status         EmailStatus @default(PENDING)
    sentAt         DateTime?
    bookingId      String?
    waitlistId     String?
    errorMessage   String?
    createdAt      DateTime    @default(now())

    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
    waitlist Waitlist? @relation(fields: [waitlistId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([status])
    @@index([emailType])
    @@index([sentAt])
}

enum EmailType {
    BOOKING_CONFIRMATION
    CANCELLATION_CONFIRMATION
    WAITLIST_NOTIFICATION
    REMINDER
    SLOT_AVAILABLE
}

enum EmailStatus {
    PENDING
    SENT
    FAILED
    BOUNCED
}
